pipeline {
    agent any
    tools {
        jdk "JDK17"
    }
    environment {
        DOCKER_IMAGE = 'ssuzyn/achacha-backend'

        // 데이터베이스 환경 변수
        SPRING_DATABASE = credentials('SPRING_DATABASE')
        SPRING_DATABASE_URL = credentials('SPRING_DATABASE_URL')

        // 클로바 OCR 환경 변수
        CLOVA_OCR_API_URL = credentials('CLOVA_OCR_API_URL')
        CLOVA_OCR_SECRET_KEY = credentials('CLOVA_OCR_SECRET_KEY')

        // FastAPI 환경변수
        AI_SERVICE_URL = credentials('FASTAPI_AI_URL')

        // S3 저장소 환경변수
        S3_ACCESS_TOKEN = credentials('S3_ACCESS_TOKEN')
        S3_SECRET_TOKEN = credentials('S3_SECRET_TOKEN')
    }
    stages {
        stage('Clone Repository') {
            steps {
                echo 'Cloning the repository...'
                git branch: 'be',
                    credentialsId: 'GITLAB_PAT',
                    url: 'https://lab.ssafy.com/s12-final/S12P31D205.git'
            }
        }

        stage('Build') {
            steps {
                dir('backend/achacha') {
                    sh 'chmod +x gradlew'
                    sh './gradlew clean build -x test'
                }
            }
        }

        stage('Docker Build & Push') {
            steps {
                dir('backend/achacha') {
                    script {
                        echo "DOCKER_IMAGE: ${env.DOCKER_IMAGE}"
                        echo "BUILD_NUMBER: ${env.BUILD_NUMBER}"

                        def dockerImage = docker.build("${env.DOCKER_IMAGE}:${env.BUILD_NUMBER}")

                        docker.withRegistry('', 'DOCKER_HUB') {
                            dockerImage.push()
                            dockerImage.push('latest')
                        }
                        env.IMAGE_TAG = "${env.DOCKER_IMAGE}:${env.BUILD_NUMBER}"
                    }
                }
            }
        }

        stage('Deploy to Server') {
            steps {
                sshPublisher(publishers: [
                    sshPublisherDesc(
                        configName: 'EC2-SSH',
                        transfers: [
                            sshTransfer(
                                execCommand: """
                                    # MySQL 컨테이너가 있는 경우만 네트워크에 연결
                                    if docker ps | grep achacha-mysql; then docker network connect achacha-network achacha-mysql || true; fi;

                                    # 최신 이미지 가져오기
                                    docker pull ${DOCKER_IMAGE}:latest;

                                    # 기존 컨테이너 중지 및 제거
                                    docker stop achacha-backend || true;
                                    docker rm achacha-backend || true;

                                    # 새 컨테이너 실행
                                    docker run -d --name achacha-backend \\
                                      -e SPRING_PROFILES_ACTIVE=prod \\
                                      -e SPRING_DATABASE_URL="${SPRING_DATABASE_URL}" \\
                                      -e SPRING_DATABASE_USERNAME="${SPRING_DATABASE_USR}" \\
                                      -e SPRING_DATABASE_PASSWORD="${SPRING_DATABASE_PSW}" \\
                                      -e CLOVA_OCR_API_URL="${CLOVA_OCR_API_URL}" \\
                                      -e CLOVA_OCR_SECRET_KEY="${CLOVA_OCR_SECRET_KEY}" \\
                                      -e AI_SERVICE_URL="${AI_SERVICE_URL}" \\
                                      -e S3_ACCESS_TOKEN="${S3_ACCESS_TOKEN}" \\
                                      -e S3_SECRET_TOKEN="${S3_SECRET_TOKEN}" \\
                                      -p 8081:8080 \\
                                      --network achacha-network \\
                                      --restart unless-stopped \\
                                      ${DOCKER_IMAGE}:latest;

                                    # 미사용 이미지 정리
                                    docker system prune -f
                                """
                            )
                        ]
                    )
                ])
            }
        }
    }

    post {
        always {
            cleanWs()
        }
        success {
            echo '[BE] 빌드 성공! ✅'
        }
        failure {
            echo '[BE] 빌드 실패! ❌'
        }
    }
}